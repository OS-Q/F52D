name: nightly

on:
  schedule:
    - cron: '0 13 * * *'


jobs:
  build:
    if: github.repository == 'OS-Q/T51D'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-18.04, ubuntu-16.04]
        ESP8266_RTOS_SDK:
          - "v3.3"
          - "v3.4"
        xtensa-lx106-elf:
          - "4.8.5"
          - "5.2.0"
          - "8.4.0"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: "recursive"
          fetch-depth: 1

      - name: Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: install xtensa-lx106-elf-8.4.0
        working-directory: DAP
        if: matrix.xtensa-lx106-elf == '8.4.0'
        run: |
          sudo apt update
          sudo apt install -y gcc git wget make libncurses-dev flex bison python python-serial ninja-build
          wget https://dl.espressif.com/dl/xtensa-lx106-elf-gcc8_4_0-esp-2020r3-linux-amd64.tar.gz
          tar -xzf ./xtensa-lx106-elf-gcc8_4_0-esp-2020r3-linux-amd64.tar.gz

      - name: install xtensa-lx106-elf-5.2.0
        working-directory: DAP
        if: matrix.xtensa-lx106-elf == '5.2.0'
        run: |
          sudo apt update
          sudo apt install -y gcc git wget make libncurses-dev flex bison python python-serial ninja-build
          wget https://dl.espressif.com/dl/xtensa-lx106-elf-linux64-1.22.0-100-ge567ec7-5.2.0.tar.gz
          tar -xzf ./xtensa-lx106-elf-linux64-1.22.0-100-ge567ec7-5.2.0.tar.gz

      - name: install xtensa-lx106-elf-4.8.5
        working-directory: DAP
        if: matrix.xtensa-lx106-elf == '4.8.5'
        run: |
          sudo apt update
          sudo apt install -y gcc git wget make libncurses-dev flex bison python python-serial ninja-build
          wget https://dl.espressif.com/dl/xtensa-lx106-elf-linux64-1.22.0-88-gde0bdc1-4.8.5.tar.gz
          tar -xzf ./xtensa-lx106-elf-linux64-1.22.0-88-gde0bdc1-4.8.5.tar.gz

      - name: install ESP8266_RTOS_SDK
        working-directory: DAP
        if: matrix.ESP8266_RTOS_SDK == 'v3.3'
        run: |
          wget https://github.com/espressif/ESP8266_RTOS_SDK/releases/download/v3.3-rc1/ESP8266_RTOS_SDK-v3.3-rc1.zip
          unzip ESP8266_RTOS_SDK-v3.3-rc1.zip
          python -m pip install --upgrade pip
          python -m pip install --user -r ./ESP8266_RTOS_SDK/requirements.txt


      - name: install ESP8266_RTOS_SDK
        working-directory: DAP
        if: matrix.ESP8266_RTOS_SDK == 'v3.4'
        run: |
          wget https://github.com/espressif/ESP8266_RTOS_SDK/releases/download/v3.3-rc1/ESP8266_RTOS_SDK-v3.4.zip
          unzip ESP8266_RTOS_SDK-v3.4.zip
          python -m pip install --user -r ./ESP8266_RTOS_SDK/requirements.txt

      - name: build
        working-directory: DAP
        id: build
        run: |
          export IDF_PATH=$PWD/ESP8266_RTOS_SDK
          export PATH="$PATH:$PWD/xtensa-lx106-elf/bin"
          echo "FIRMWARE=$PWD/build" >> $GITHUB_ENV
          python ./idf.py fullclean
          python ./idf.py build
          echo "::set-output name=status::success"
